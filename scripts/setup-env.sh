#!/bin/bash

# LMS Environment Setup Script
# This script helps set up environment variables securely

set -e

echo "🔧 Setting up LMS development environment..."

# Function to generate a secure random string
generate_secret() {
    local length=${1:-32}
    openssl rand -base64 $length | tr -d "=+/" | cut -c1-$length
}

# Check if .env.local exists
if [ ! -f ".env.local" ]; then
    echo "📝 Creating .env.local file..."
    
    # Generate secure secrets
    JWT_SECRET=$(generate_secret 64)
    JWT_REFRESH_SECRET=$(generate_secret 64)
    DB_PASSWORD=$(generate_secret 16)
    
    cat > .env.local << EOF
# Local development environment variables
# This file is automatically generated and should NOT be committed

# Database Configuration
LMS_DATABASE_PASSWORD=${DB_PASSWORD}

# JWT Configuration
LMS_JWT_SECRET=${JWT_SECRET}
LMS_JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}

# Email Configuration (optional for development)
# LMS_EMAIL_USERNAME=your-email@gmail.com
# LMS_EMAIL_PASSWORD=your-app-password

# Redis Configuration (if different from default)
# REDIS_URL=redis://localhost:6379/0
EOF
    
    echo "✅ .env.local created with secure secrets"
else
    echo "⚠️  .env.local already exists, skipping creation"
fi

# Set proper permissions
chmod 600 .env.local 2>/dev/null || true

echo "🚀 Environment setup complete!"
echo ""
echo "Next steps:"
echo "1. Review .env.local and update any values as needed"
echo "2. Start the database: make docker-services"
echo "3. Run migrations: make migrate-up"
echo "4. Start development server: make dev"